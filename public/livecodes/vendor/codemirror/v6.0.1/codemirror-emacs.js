import{Prec as y,StateEffect as L,StateField as x,MapMode as R,EditorSelection as d}from"@codemirror/state";import{EditorView as S,Direction as D,ViewPlugin as E,showPanel as $}from"@codemirror/view";import*as r from"@codemirror/commands";import{startCompletion as b}from"@codemirror/autocomplete";import{openSearchPanel as M}from"@codemirror/search";var v=class{constructor(e,t,s,o,n,l){this.left=e,this.top=t,this.height=s,this.className=o,this.letter=n,this.partial=l}draw(){let e=document.createElement("div");return e.className=this.className,this.adjust(e),e}adjust(e){e.style.left=this.left+"px",e.style.top=this.top+"px",e.style.height=this.height+"px",e.style.lineHeight=this.height+"px",e.style.color=this.partial?"transparent":"",e.className=this.className,e.textContent=this.letter}eq(e){return this.left==e.left&&this.top==e.top&&this.letter==e.letter&&this.height==e.height&&this.className==e.className}},C=class{constructor(e){this.view=e,this.rangePieces=[],this.cursors=[],this.measureReq={read:this.readPos.bind(this),write:this.drawSel.bind(this)},this.cursorLayer=e.scrollDOM.appendChild(document.createElement("div")),this.cursorLayer.className="cm-cursorLayer cm-vimCursorLayer",this.cursorLayer.setAttribute("aria-hidden","true"),e.requestMeasure(this.measureReq),this.setBlinkRate()}setBlinkRate(){this.cursorLayer.style.animationDuration="1200ms"}update(e){(e.selectionSet||e.geometryChanged||e.viewportChanged)&&(this.view.requestMeasure(this.measureReq),this.cursorLayer.style.animationName=this.cursorLayer.style.animationName=="cm-blink"?"cm-blink2":"cm-blink")}scheduleRedraw(){this.view.requestMeasure(this.measureReq)}readPos(){let{state:e}=this.view,t=[];for(let s of e.selection.ranges){let o=s==e.selection.main,n=B(null,this.view,s,o);n&&t.push(n)}return{cursors:t}}drawSel({cursors:e}){if(e.length!=this.cursors.length||e.some((t,s)=>!t.eq(this.cursors[s]))){let t=this.cursorLayer.children;if(t.length!==e.length){this.cursorLayer.textContent="";for(let s of e)this.cursorLayer.appendChild(s.draw())}else e.forEach((s,o)=>s.adjust(t[o]));this.cursors=e}}destroy(){this.cursorLayer.remove()}},O={".cm-line":{"& ::selection":{backgroundColor:"transparent !important"},"&::selection":{backgroundColor:"transparent !important"},caretColor:"transparent !important"},".cm-fat-cursor":{position:"absolute",background:"#ff9696",border:"none",whiteSpace:"pre"},"&:not(.cm-focused) .cm-fat-cursor":{background:"none",outline:"solid 1px #ff9696"}},P=y.highest(S.theme(O));function A(a){let e=a.scrollDOM.getBoundingClientRect();return{left:(a.textDirection==D.LTR?e.left:e.right-a.scrollDOM.clientWidth)-a.scrollDOM.scrollLeft,top:e.top-a.scrollDOM.scrollTop}}function B(a,e,t,s){let o=t.head;var n=1;let l=e.coordsAtPos(o,t.assoc||1);if(!l)return null;let c=A(e),i=o<e.state.doc.length&&e.state.sliceDoc(o,o+1);(!i||i==`
`||i=="\r")&&(i="\xA0");let m=l.bottom-l.top;return new v(l.left-c.left,l.top-c.top+m*(1-n),m*n,s?"cm-fat-cursor cm-cursor-primary":"cm-fat-cursor cm-cursor-secondary",i,n!=1)}var T=S.theme({".cm-emacsMode .cm-cursorLayer:not(.cm-vimCursorLayer)":{display:"none"},".cm-vim-panel":{padding:"5px 10px",backgroundColor:"#fffa8f",fontFamily:"monospace"},".cm-vim-panel input":{border:"none",outline:"none",backgroundColor:"#fffa8f"}}),N=E.fromClass(class{constructor(a){this.status="",this.view=a,this.em=new h(a),this.blockCursor=new C(a),this.view.scrollDOM.classList.add("cm-emacsMode")}update(a){a.docChanged&&(this.em.$emacsMark=null,this.em.updateMarksOnChange(a.changes)),this.blockCursor.update(a)}destroy(){this.view.scrollDOM.classList.remove("cm-emacsMode"),this.blockCursor.destroy()}},{eventHandlers:{keydown:function(a,e){var t=this.em.handleKeyboard(a);return!!t},mousedown:function(){this.em.$emacsMark=null}}}),K=L.define(),I=x.define({create:()=>!1,update(a,e){for(let t of e.effects)t.is(K)&&(a=t.value);return a},provide:a=>$.from(a,e=>e?U:null)});function U(a){let e=document.createElement("div");return e.className="cm-vim-panel",{top:!1,dom:e}}function j(a={}){return[T,N,P,I]}var q={Return:"Return",Escape:"Esc",Insert:"Ins",ArrowLeft:"Left",ArrowRight:"Right",ArrowUp:"Up",ArrowDown:"Down",Enter:"Return",Divide:"/",Slash:"/",Multiply:"*",Subtract:"-",Minus:"-",Equal:"="},F={Shift:1,Alt:1,Command:1,Control:1,CapsLock:1},p={},h=class a{constructor(e){this.view=e,this.$data={count:0,keyChain:"",lastCommand:""},this.$emacsMarkRing=[],this.$emacsMark=null}static bindKey(e,t){e.split("|").forEach(function(s){let o="",n=s.split(/\s+/);n.forEach(function(l,c){let i=l.split(/-(?=.)/),m=i.pop();i.length&&(o+=i.sort().join("-")+"-"),o+=m,c===n.length-1?p[o]=t:(p[o]="null",o+=" ")})})}static getKey(e){var t=e.code,s=e.key;if(F[s])return["","",""];t.length>1&&(t[0]=="N"&&(t=t.replace(/^Numpad/,"")),t[0]=="K"&&(t=t.replace(/^Key/,""))),t=q[t]||t,t.length==1&&(t=t.toLowerCase());var o="";return e.ctrlKey&&(o+="C-"),e.metaKey&&(o+="CMD-"),e.altKey&&(o+="M-"),e.shiftKey&&(o+="S-"),[t,o,s]}static addCommands(e){Object.keys(e).forEach(function(t){var s=e[t];typeof s=="function"&&(s={exec:s}),a.commands[t]=s})}static execCommand(e,t,s,o=1){var n=void 0;if(typeof e=="function")for(var l=0;l<o;l++)e(t.view);else if(e!=="null")if(e.exec){o>1&&e.handlesCount&&(s||(s={}),typeof s=="object"&&(s.count=o),o=1);for(var l=0;l<o;l++)n=e.exec(t,s||{})}else throw new Error("missformed command");return n}handleKeyboard(e){var t=a.getKey(e),s=this.findCommand(t);if(s&&s.command){var o=a.execCommand(s.command,this,s.args,s.count);if(o===!1)return}return s}findCommand([e,t,s]){if(e){var o=this,n=this.$data;if(!t&&e.length==1&&(o.pushEmacsMark(),n.count)){var l=new Array(n.count+1).join(s);return n.count=null,{command:"insertstring",args:l}}if(t=="C-"||n.count){var m=parseInt(e[e.length-1]);if(typeof m=="number"&&!isNaN(m))return n.count=Math.max(n.count||0,0),n.count=10*n.count+m,{command:"null"}}t&&(e=t+e),n.keyChain&&(e=n.keyChain+=" "+e);var c=p[e];if(n.keyChain=c=="null"?e:"",!!c){if(c==="null")return{command:"null"};if(c==="universalArgument")return n.count=-4,{command:"null"};var i;if(typeof c!="string"&&(i=c.args,c.command&&(c=c.command)),(c==="insertstring"||c===r.splitLine||c===r.toggleComment)&&o.pushEmacsMark(),!(typeof c=="string"&&(c=a.commands[c],!c))){!c.readOnly&&!c.isYank&&(n.lastCommand=null);var m=n.count||1;return n.count&&(n.count=0),{command:c,args:i,count:m}}}}}showCommandLine(e){console.error("TODO")}updateMarksOnChange(e){this.$emacsMark&&(this.$emacsMark=this.updateMark(this.$emacsMark,e)),this.$emacsMarkRing=this.$emacsMarkRing.map(t=>this.updateMark(t,e)).filter(Boolean)}updateMark(e,t){if(e){var s=e.map(function(o){return t.mapPos(o,1,R.TrackDel)}).filter(o=>o!=null);return s.length==0?null:s}}emacsMark(){return this.$emacsMark}setEmacsMark(e){this.$emacsMark=e}pushEmacsMark(e,t){var s=this.$emacsMark;s&&this.$emacsMarkRing.push(s),!e||t?this.setEmacsMark(e):this.$emacsMarkRing.push(e)}popEmacsMark(){var e=this.emacsMark();return e?(this.setEmacsMark(null),e):this.$emacsMarkRing.pop()}getLastEmacsMark(){return this.$emacsMark||this.$emacsMarkRing.slice(-1)[0]}getCopyText(){var e=this.view.state;return e.selection.ranges.map(t=>e.sliceDoc(t.from,t.to)).join(`
`)}clearSelection(){var e=this.view,t=e.state.selection,s=!t.ranges.some(n=>n.from!=n.to);if(s)return!1;var o=t.ranges.map(n=>d.range(n.head,n.head));return e.dispatch({selection:d.create(o,t.mainIndex)}),!0}onPaste(e){var t=this.view,s=t.state.selection,o;if(s.ranges.length>1){var n=e.split(`
`);n.length==s.ranges.length&&(o=n)}var l=0,c=t.state.changeByRange(i=>{var m=o?o[l]:e;return l++,{changes:{from:i.from,to:i.to,insert:m},range:d.cursor(i.from+m.length)}});t.dispatch(c)}};h.commands={};var w={"Up|C-p":{command:"goOrSelect",args:[r.cursorLineUp,r.selectLineUp]},"Down|C-n":{command:"goOrSelect",args:[r.cursorLineDown,r.selectLineDown]},"Left|C-b":{command:"goOrSelect",args:[r.cursorCharBackward,r.selectCharBackward]},"Right|C-f":{command:"goOrSelect",args:[r.cursorCharForward,r.selectCharForward]},"C-Left|M-b":{command:"goOrSelect",args:[r.cursorGroupLeft,r.selectGroupLeft]},"C-Right|M-f":{command:"goOrSelect",args:[r.cursorGroupRight,r.selectGroupRight]},"Home|C-a":{command:"goOrSelect",args:[r.cursorLineStart,r.selectLineStart]},"End|C-e":{command:"goOrSelect",args:[r.cursorLineEnd,r.selectLineEnd]},"C-Home|S-M-,":{command:"goOrSelect",args:[r.cursorDocStart,r.selectDocStart]},"C-End|S-M-.":{command:"goOrSelect",args:[r.cursorDocEnd,r.selectDocEnd]},"S-Up|S-C-p":r.selectLineUp,"S-Down|S-C-n":r.selectLineDown,"S-Left|S-C-b":r.selectCharBackward,"S-Right|S-C-f":r.selectCharForward,"S-C-Left|S-M-b":r.selectGroupBackward,"S-C-Right|S-M-f":r.selectGroupForward,"S-Home|S-C-a":r.selectLineStart,"S-End|S-C-e":r.selectLineEnd,"S-C-Home":r.selectDocStart,"S-C-End":r.selectDocEnd,"C-l":"recenterTopBottom","M-s":"centerSelection","M-g":"gotoline","C-x C-p|C-x h":r.selectAll,"PageDown|C-v|C-Down":{command:"goOrSelect",args:[r.cursorPageDown,r.selectPageDown]},"PageUp|M-v|C-Up":{command:"goOrSelect",args:[r.cursorPageUp,r.selectPageDown]},"S-C-Down":r.selectPageDown,"S-C-Up":r.selectPageUp,"C-s":M,"C-r":M,"M-C-s":"findnext","M-C-r":"findprevious","S-M-5":"replace",Backspace:r.deleteCharBackward,"Delete|C-d":r.deleteCharForward,"Return|C-m":{command:"insertstring",args:`
`},"C-o":r.splitLine,"M-d|C-Delete":{command:"killWord",args:"right"},"C-Backspace|M-Backspace|M-Delete":{command:"killWord",args:"left"},"C-k":"killLine","M-h":"selectParagraph","M-@|M-S-2":"markWord","C-y|S-Delete":"yank","M-y":"yankRotate","C-g":"keyboardQuit","C-w|C-S-w":"killRegion","M-w":"killRingSave","C-Space":"setMark","C-x C-x":"exchangePointAndMark","C-t":r.transposeChars,"M-u":{command:"changeCase",args:{dir:1}},"M-l":{command:"changeCase",args:{dir:-1}},"C-x C-u":{command:"changeCase",args:{dir:1,region:!0}},"C-x C-l":{command:"changeCase",args:{dir:1,region:!0}},"M-/":b,"C-u":"universalArgument","M-;":r.toggleComment,"C-/|C-x u|S-C--|C-z":r.undo,"S-C-/|S-C-x u|C--|S-C-z":r.redo,"C-x r":"selectRectangularRegion","M-x":{command:"focusCommandLine",args:"M-x "},Esc:"unsetTransientMark"};for(let a in w)h.bindKey(a,w[a]);h.addCommands({unsetTransientMark:function(a){return a.setEmacsMark(null),!1},markWord:function(a,e){},selectParagraph:function(a,e){for(var t=a.view,s=t.state.selection.ranges[0].head,o=t.state.doc,n=o.lineAt(s),l=-1,c=-1,i=n;/\S/.test(i.text)&&i.from>0;)l=i.from,i=t.state.doc.lineAt(i.from-1);if(l==-1)for(;!/\S/.test(i.text)&&i.to<o.length;)l=i.from,i=t.state.doc.lineAt(i.to+1);else i=n;for(;/\S/.test(i.text)&&i.to<o.length;)c=i.to,i=t.state.doc.lineAt(i.to+1);c==-1&&(c=n.to);var m=[d.range(l,c)];t.dispatch({selection:d.create(m)})},goOrSelect:{exec:function(a,e){var t=a.emacsMark()?e[1]:e[0];t(a.view)}},changeCase:function(a,e){var t=a.view;e.region||(a.clearSelection(),r.selectGroupForward(t));var s=t.state.changeByRange(o=>{var n=t.state.sliceDoc(o.from,o.to);return n=e.dir==1?n.toUpperCase():n.toLowerCase(),{changes:{from:o.from,to:o.to,insert:n},range:d.cursor(o.from+n.length)}});t.dispatch(s)},centerSelection:function(a){a.view.dispatch({scrollIntoView:!0})},recenterTopBottom:function(a){var e=a.view,t=e.scrollDOM.scrollTop;e.dispatch({scrollIntoView:!0});try{e.measure(!0)}catch{}if(t==e.scrollDOM.scrollTop){var s=e.scrollDOM.getBoundingClientRect(),o=e.coordsAtPos(e.state.selection.main.head);if(o){var n=o.bottom-o.top,l=s.height,c=o.top-s.top;Math.abs(c)<n/4?t+=c+n-l+2:Math.abs(c-l*.5)<n/4?t+=c-2:t+=c-l*.5,e.scrollDOM.scrollTop=t}}},selectRectangularRegion:function(a){var e=a.view,t=e.state.selection.ranges,s=[];if(t.length>1)s.push(d.range(t[0].from,t[t.length-1].to));else{let o=e.state.doc,n=o.lineAt(t[0].from),l=o.lineAt(t[0].to),c=t[0].from-n.from,i=t[0].to-l.from;for(;n.from<l.to&&(s.push(d.range(n.from+c,n.from+i)),!(n.to+1>=o.length));)n=o.lineAt(n.to+1)}e.dispatch({selection:d.create(s)})},setMark:{exec:function(a,e){var t=a.view,s=t.state.selection.ranges;if(e&&e.count){var n=a.popEmacsMark();if(n){var o=n.map(m=>d.cursor(m,m));t.dispatch({selection:d.create(o)})}return}var n=a.emacsMark(),l=s.map(function(i){return i.from}),c=s.every(function(i){return i.from==i.to});if(n||!c){a.clearSelection(),n&&a.pushEmacsMark(null);return}if(!n){a.pushEmacsMark(l),a.setEmacsMark(l);return}},readOnly:!0,handlesCount:!0},exchangePointAndMark:{exec:function(e,t){var s=e.view,o=s.state.selection,n=!o.ranges.some(f=>f.from!=f.to);if(!t.count&&!n){var l=o.ranges.map(f=>d.range(f.head,f.anchor));s.dispatch({selection:d.create(l,o.mainIndex)});return}var c=e.$emacsMarkRing,i=c[c.length-1];if(i)if(t.count){e.clearSelection();var l=i.map(k=>d.range(k,k));s.dispatch({selection:d.create(l,o.mainIndex)})}else{var m=Math.min(i.length,o.ranges.length);l=[];for(var g=0;g<m;g++)l.push(d.range(o.ranges[g].head,i[g]))}},readOnly:!0,handlesCount:!0},killWord:{exec:function(a,e){var t=a.view,s=t.state.selection,o=s.ranges.map(n=>d.range(n.head,n.head));t.dispatch({selection:d.create(o,s.mainIndex)}),e=="left"?r.selectGroupBackward(t):r.selectGroupForward(t),s=t.state.selection,s.ranges.forEach(n=>{var l=t.state.sliceDoc(n.from,n.to);u.add(l)}),t.dispatch(t.state.replaceSelection(""))}},killLine:function(a){a.pushEmacsMark(null),a.clearSelection(),r.selectLineEnd(a.view);var e=a.view,t=e.state,s=[],o=a.view.state.selection.ranges.map(function(n){var l=n.from,c=n.to,i=t.sliceDoc(l,c);return s.push(i),/^\s*$/.test(i)&&(c+=1,s.push(`
`)),{from:l,to:c,insert:""}});a.$data.lastCommand=="killLine"?u.append(s.join(`
`)):u.add(s.join(`
`)),e.dispatch({changes:o})},yank:function(a){a.onPaste(u.get()),a.$data.lastCommand="yank"},yankRotate:function(a){a.$data.lastCommand=="yank"&&(r.undo(a.view),a.$emacsMarkRing.pop(),a.onPaste(u.rotate()),a.$data.lastCommand="yank")},killRegion:{exec:function(a){u.add(a.getCopyText());var e=a.view;e.dispatch(e.state.replaceSelection("")),a.setEmacsMark(null)}},killRingSave:{exec:function(a){var e=a.getCopyText();u.add(e),a.clearSelection(),navigator.clipboard.writeText(e)},readOnly:!0},keyboardQuit:function(a){var e=a.view,t=e.state.selection,s=!t.ranges.some(n=>n.from!=n.to);if(t.ranges.length>1&&!s){var o=t.ranges.map(n=>d.range(n.head,n.head));e.dispatch({selection:d.create(o,t.mainIndex)})}else r.simplifySelection(a.view);a.setEmacsMark(null),a.$data.count=null},focusCommandLine:function(a,e){a.showCommandLine(e)}});var u={$data:[],add:function(a){a&&this.$data.push(a),this.$data.length>30&&this.$data.shift()},append:function(a){var e=this.$data.length-1,t=this.$data[e]||"";a&&(t+=a),t&&(this.$data[e]=t)},get:function(a){return a=a||1,this.$data.slice(this.$data.length-a,this.$data.length).reverse().join(`
`)},pop:function(){return this.$data.length>1&&this.$data.pop(),this.get()},rotate:function(){let a=this.$data.pop();return a&&this.$data.unshift(a),this.get()}};export{j as emacs};
//# sourceMappingURL=codemirror-emacs.js.map
